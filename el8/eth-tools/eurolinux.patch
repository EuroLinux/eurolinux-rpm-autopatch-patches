From ec05d7839ca176bd6970c59711f8800ab74775b6 Mon Sep 17 00:00:00 2001
From: Alex Baranowski <alex@euro-linux.com>
Date: Sun, 9 Apr 2023 20:36:06 +0200
Subject: [PATCH] fixes for eurolinux

---
 CommonInstall/util_init.pl | 13 ++++++++++++-
 MakeTools/funcs-ext.sh     | 10 ++++++++++
 get_id_and_versionid.sh    |  7 +++++++
 update_eth_spec.sh         |  2 +-
 4 files changed, 30 insertions(+), 2 deletions(-)

diff --git a/CommonInstall/util_init.pl b/CommonInstall/util_init.pl
index 07220bd..44e7fa5 100755
--- a/CommonInstall/util_init.pl
+++ b/CommonInstall/util_init.pl
@@ -213,7 +213,7 @@ sub os_vendor_version($)
 			chop($rval);
 			$rval="ES".$rval;
 			if ( -e "/etc/redhat-release" ) {
-				if (!system("grep -qi centos /etc/redhat-release") || !system("grep -qi rocky /etc/redhat-release") || !system("grep -qi almalinux /etc/redhat-release") || !system("grep -qi circle /etc/redhat-release")) {
+				if (!system("grep -qi centos /etc/redhat-release") || !system("grep -qi rocky /etc/redhat-release") || !system("grep -qi almalinux /etc/redhat-release") || !system("grep -qi circle /etc/redhat-release")) || !system("grep -qi eurolinux /etc/redhat-release")) {
 					$rval = `cat /etc/redhat-release | cut -d' ' -f4`;
 					$rval =~ m/(\d+).(\d+)/;
 					if ($2 eq "0") {
@@ -267,6 +267,12 @@ sub os_vendor_version($)
 			$rval = `cat /etc/redhat-release`;
 			$rval =~ m/(\d+).(\d+)/;
 			$rval="ES".$1.$2;
+                } elsif (!system("grep -qi eurolinux /etc/redhat-release")) {
+                       # Find a number of the form "#.#" and output the portion
+                       # to the left of the decimal point.
+                       $rval = `cat /etc/redhat-release`;
+                       $rval =~ m/(\d+).(\d+)/;
+                       $rval="ES".$1.$2;
 		} elsif (!system("grep -qi Scientific /etc/redhat-release")) {
 			# Find a number of the form "#.#" and output the portion
 			# to the left of the decimal point.
@@ -322,6 +328,8 @@ sub determine_os_version()
 		$CUR_DISTRO_VENDOR = "redhat";
 	} elsif ( -s "/etc/rocky-release" ) {
 		$CUR_DISTRO_VENDOR = "redhat";
+	} elsif ( -s "/etc/el-release" ) {
+		$CUR_DISTRO_VENDOR = "redhat";
 	} elsif ( -s "/etc/almalinux-release" ) {
 		$CUR_DISTRO_VENDOR = "redhat";
 	} elsif ( -s "/etc/circle-releas" ) {
@@ -342,6 +350,7 @@ sub determine_os_version()
 	} elsif ( -e $os_release_file) {
 		my %distroVendor = (
 			"rhel" => "redhat",
+			"eurolinux" => "redhat",
 			"centos" => "redhat",
 			"rocky" => "redhat",
 			"almalinux" => "redhat",
@@ -384,6 +393,8 @@ sub determine_os_version()
 			Abort "Please contact your support representative...\n";
 		} elsif ($CUR_DISTRO_VENDOR eq "SuSE") {
 			$NETWORK_CONF_DIR = "/etc/sysconfig/network";
+		} elsif ($CUR_DISTRO_VENDOR eq "eurolinux") {
+			$CUR_DISTRO_VENDOR = "redhat";
 		} elsif ($CUR_DISTRO_VENDOR eq "centos") {
 			$CUR_DISTRO_VENDOR = "redhat";
 		} elsif ($CUR_DISTRO_VENDOR eq "rocky") {
diff --git a/MakeTools/funcs-ext.sh b/MakeTools/funcs-ext.sh
index a5ee8ab..9912ad0 100755
--- a/MakeTools/funcs-ext.sh
+++ b/MakeTools/funcs-ext.sh
@@ -722,6 +722,9 @@ function os_vendor()
             sle_hpc)
                 rval=SuSE
                 ;;
+            eurolinux)
+                rval=redhat
+                ;;
             centos)
                 rval=redhat
                 ;;
@@ -766,6 +769,9 @@ function os_vendor()
 				rval=UnitedLinux
 			fi
 		elif [ $rval = 'centos' ]
+		then
+			rval=redhat
+		elif [ $rval = 'eurolinux' ]
 		then
 			rval=redhat
 		elif [ $rval = 'rocky' ]
@@ -855,6 +861,10 @@ function os_vendor_version()
 		then
 			# Rocky Linux
 			rval="ES"`cat /etc/redhat-release | sed -r 's/^.+([[:digit:]])\.([[:digit:]]).+$/\1\2/'`
+                elif grep -qi eurolinux /etc/redhat-release
+                then
+                        # EuroLinux
+                        rval="ES"`cat /etc/redhat-release | sed -r 's/^.+([[:digit:]])\.([[:digit:]]).+$/\1\2/'`
 		elif grep -qi almalinux /etc/redhat-release
 		then
 			# AlmaLinux
diff --git a/get_id_and_versionid.sh b/get_id_and_versionid.sh
index deaeb43..ceceb01 100755
--- a/get_id_and_versionid.sh
+++ b/get_id_and_versionid.sh
@@ -27,6 +27,9 @@ else
 				    rval=UnitedLinux
 			    fi
 			elif [ $rval = 'centos' ]
+			then
+				rval=redhat
+			elif [ $rval = 'eurolinux' ]
 			then
 				rval=redhat
 			elif [ $rval = 'rocky' ]
@@ -76,6 +79,10 @@ else
 		then
 			# CentOS 
 			rval=`cat /etc/redhat-release | sed -r 's/^.+([[:digit:]])\.([[:digit:]]).+$/\1.\2/'`
+                elif grep -qi eurolinux /etc/redhat-release
+                then
+                        # EuroLinux
+                        rval="ES"`cat /etc/redhat-release | sed -r 's/^.+([[:digit:]])\.([[:digit:]]).+$/\1\2/'`
 		elif grep -qi rocky /etc/redhat-release
 		then
 			# Rocky Linux
diff --git a/update_eth_spec.sh b/update_eth_spec.sh
index 83a44ad..dde70bc 100755
--- a/update_eth_spec.sh
+++ b/update_eth_spec.sh
@@ -51,7 +51,7 @@ fi
 
 source ./OpenIb_Host/ff_filegroups.sh
 
-if [ "$id" = "rhel" -o "$id" = "centos" -o "$id" = "rocky" -o "$id" = "almalinux" -o "$id" = "circle" ]
+if [ "$id" = "rhel" -o "$id" = "centos" -o "$id" = "rocky" -o "$id" = "almalinux" -o "$id" = "circle" -o "$id" = "eurolinux" ]
 then
 	# __RPM_REQ_BASIC -
 	sed -i "s/__RPM_REQ_BASIC1/expect%{?_isa}, tcl%{?_isa}, libibverbs-utils%{?_isa}, librdmacm-utils%{?_isa}, net-snmp%{?_isa}, net-snmp-utils%{?_isa}/g" eth-tools.spec
-- 
2.31.1

